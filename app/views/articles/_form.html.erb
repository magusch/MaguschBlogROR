<%= render 'shared/errors', obj: @article %>
<%= form_for(@article, :html => {class: "form-horizontal", role: "form"}) do |form| %>
  <div class="form-group">
    <div class="control-label col-sm-2">
      <%= form.label :title %>
    </div>
    <div class="col-sm-6">
      <%= form.text_field :title, class: "form-control", placeholder: "Title of article", autofocus: true %>
    </div>
  </div>

  <div class="form-group">
    <div class="control-label col-sm-2">
      <%= form.label :body %>
    </div>
    <div class="col-sm-6">
      <%= form.text_area :body, rows: 10, class: "form-control", placeholder: "Body of article" %>
    </div>
  </div>
  <div class="form-group">
    <div class="control-label col-sm-2">
      <%= form.label :status %>
    </div>
    <div class="col-sm-6">
      <%= form.select :status, ['public', 'private', 'archived'], prompt: "Select Status", class: "form-control" %>
    </div>
  </div>
  <div class="form-group">
    <div class="control-label col-sm-2">
      <%= form.label :images, 'Upload Images' %>
    </div>
    <div class="col-sm-6">
      <div class="field">
        <%= form.file_field :images, multiple: true, class: "form-control", accept: "image/*"  %>
      </div>
      <table id="image-selected">

      </table>
    </div>
  </div>
  <div class="form-group">
    <%= form.hidden_field :user_id, value: current_user.id %>

    <div class="col-sm-offset-2 col-sm-10">
      <%= form.submit class: 'btn btn-primary btn-large' %>
    </div>
  </div>
  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <a id="markdownText">Show result</a>
      <p>
        <div id="html_body_text" ></div>
      </p>
    </div>
  </div>

  <script>

    function addImageToTextArea() {
        var textArea = document.getElementById("article_body");
        textArea.value += arguments[0];
    }

      $(document).ready(function () {
          $('#article_images').on('change', function () {
              const previewContainer = $('#image-selected');
              previewContainer.empty();
              images_data = []
              const files = $(this)[0].files;
              for (let i = 0; i < files.length; i++) {
                  const file = files[i];
                  const reader = new FileReader();

                  reader.onload = function (e) {
                      const preview = `<div class="image-preview" >
                        <img src="${e.target.result}"  width="40%" alt="Image Preview" />
                        <p>Image ${i + 1}</p>
                      </div>`;
                      images_data.push(preview)
                      // previewContainer.append(preview);
                      // add function with button [image-1] [image-2] [image-3] to textarea
                      previewContainer.append(`
                               <button type="button" class="btn btn-info" onclick="addImageToTextArea('[image-${i + 1}]')">[image-${i + 1}]</button>
                            `)
                  };

                  reader.readAsDataURL(file);
              }

              previewContainer.append("<p>" + files.length + " images selected </p>");

          });
      });


      $(document).ready(function () {
          $('#markdownText').click(function () {
              // Get the text from the textarea
              var articleBody = $('#article_body').val();
              // Make an AJAX POST request to your 'page' endpoint
              $.ajax({
                  type: 'POST',
                  url: '/articles/markdown_to_html', // Replace with the actual URL of your 'page' endpoint
                  data: { input_text: articleBody }, // Send the article body as data
                  success: function (response) {

                      prepared_post = response['html_text'];
                      // replace [image-1] with the first image
                      for (var i = 0; i < images_data.length; i++) {
                          prepared_post = prepared_post.replace("[image-" + (i + 1) + "]", images_data[i]);
                      }

                      // Update the content of the 'ready_html_text' div with the response
                      $('#html_body_text').html(prepared_post);
                  },
                  error: function (error) {
                      console.error('Error:', error);
                  },
              });
          });
      });



  </script>



<% end %>